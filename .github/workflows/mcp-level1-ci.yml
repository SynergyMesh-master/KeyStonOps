name: MCP Level 1 CI/CD

on:
  push:
    branches: [ main, develop, feature/* ]
    paths:
      - '00-namespaces/namespaces-mcp/level1/**'
      - '.github/workflows/mcp-level1-ci.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '00-namespaces/namespaces-mcp/level1/**'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

env:
  PYTHON_VERSION: '3.11'
  WORKING_DIRECTORY: '00-namespaces/namespaces-mcp/level1'

jobs:
  # Validate Level 1 Artifacts
  validate-artifacts:
    name: Validate Level 1 Artifacts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        working-directory: ${{ env.WORKING_DIRECTORY }}/tools
        run: |
          pip install -r requirements.txt

      - name: Validate Core Artifacts
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "Validating Core artifacts..."
          python3 tools/validator.py --artifact core/manifest.yaml --strict
          python3 tools/validator.py --artifact core/schema.yaml --strict
          python3 tools/validator.py --artifact core/spec.yaml --strict
          python3 tools/validator.py --artifact core/index.yaml --strict
          python3 tools/validator.py --artifact core/categories.yaml --strict
          python3 tools/validator.py --artifact core/governance.yaml --strict
          python3 tools/validator.py --artifact core/policies.yaml --strict
          python3 tools/validator.py --artifact core/roles.yaml --strict
          python3 tools/validator.py --artifact core/tools.yaml --strict

      - name: Validate Governance Artifacts
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "Validating Governance artifacts..."
          python3 tools/validator.py --artifact governance/manifest.yaml --strict
          python3 tools/validator.py --artifact governance/schema.yaml --strict

      - name: Generate Validation Report
        if: always()
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "# MCP Level 1 Validation Report" > validation-report.md
          echo "" >> validation-report.md
          echo "## Summary" >> validation-report.md
          echo "- Date: $(date)" >> validation-report.md
          echo "- Branch: ${{ github.ref_name }}" >> validation-report.md
          echo "- Commit: ${{ github.sha }}" >> validation-report.md
          echo "" >> validation-report.md
          echo "## Artifacts Validated" >> validation-report.md
          echo "- Core: 9 artifacts" >> validation-report.md
          echo "- Governance: 2 artifacts" >> validation-report.md

      - name: Upload Validation Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-report
          path: ${{ env.WORKING_DIRECTORY }}/validation-report.md
          retention-days: 30

  # Check Naming Conventions
  check-naming:
    name: Check Naming Conventions
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Artifact Names
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "Checking naming conventions..."
          
          # Check for reverse-DNS format in metadata.name
          find . -name "*.yaml" -type f -exec grep -l "metadata:" {} \; | while read file; do
            echo "Checking $file..."
            if grep -q "name: io.github.machinenativeops/" "$file"; then
              echo "‚úÖ $file: Valid naming format"
            else
              echo "‚ö†Ô∏è  $file: Check naming format"
            fi
          done

      - name: Check Version Format
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "Checking version format..."
          
          # Check for semantic versioning
          find . -name "*.yaml" -type f -exec grep -l "version:" {} \; | while read file; do
            if grep -qE 'version: "[0-9]+\.[0-9]+\.[0-9]+"' "$file"; then
              echo "‚úÖ $file: Valid version format"
            else
              echo "‚ö†Ô∏è  $file: Check version format"
            fi
          done

  # Validate Dependencies
  validate-dependencies:
    name: Validate Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Check Dependency Integrity
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          python3 << 'EOF'
          import yaml
          from pathlib import Path
          
          def check_dependencies(artifact_path):
              with open(artifact_path, 'r') as f:
                  artifact = yaml.safe_load(f)
              
              if 'dependsOn' not in artifact:
                  return True
              
              for dep in artifact['dependsOn']:
                  dep_artifact = dep.get('artifact')
                  if not dep_artifact:
                      print(f"‚ùå {artifact_path}: Missing artifact in dependency")
                      return False
                  
                  # Check if dependency file exists
                  dep_path = Path(artifact_path).parent / dep_artifact
                  if not dep_path.exists():
                      print(f"‚ö†Ô∏è  {artifact_path}: Dependency {dep_artifact} not found")
                  else:
                      print(f"‚úÖ {artifact_path}: Dependency {dep_artifact} exists")
              
              return True
          
          # Check all YAML files
          for yaml_file in Path('.').rglob('*.yaml'):
              if 'examples' not in str(yaml_file):
                  check_dependencies(yaml_file)
          EOF

  # Security Scan
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '${{ env.WORKING_DIRECTORY }}'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # Documentation Check
  docs-check:
    name: Documentation Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check README files
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "Checking for README files..."
          
          required_readmes=(
            "README.md"
            "core/README.md"
            "governance/README.md"
          )
          
          for readme in "${required_readmes[@]}"; do
            if [ -f "$readme" ]; then
              echo "‚úÖ Found: $readme"
            else
              echo "‚ùå Missing: $readme"
              exit 1
            fi
          done

      - name: Check Tutorial files
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "Checking for tutorial files..."
          
          if [ -d "tutorials" ]; then
            tutorial_count=$(find tutorials -name "*.md" | wc -l)
            echo "‚úÖ Found $tutorial_count tutorial files"
          else
            echo "‚ö†Ô∏è  No tutorials directory found"
          fi

      - name: Check Example files
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "Checking for example files..."
          
          if [ -d "examples" ]; then
            example_count=$(find examples -name "*.yaml" | wc -l)
            echo "‚úÖ Found $example_count example files"
          else
            echo "‚ö†Ô∏è  No examples directory found"
          fi

  # Compliance Check
  compliance-check:
    name: Compliance Check
    runs-on: ubuntu-latest
    needs: [validate-artifacts, check-naming, validate-dependencies]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Check MCP Registry API Compliance
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "Checking MCP Registry API v1.0 compliance..."
          
          # Check for required fields
          required_fields=("apiVersion" "kind" "metadata")
          
          for field in "${required_fields[@]}"; do
            echo "Checking for $field..."
            if grep -r "$field:" core/ governance/ > /dev/null; then
              echo "‚úÖ $field found"
            else
              echo "‚ùå $field missing"
              exit 1
            fi
          done

      - name: Check Semantic Versioning Compliance
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          echo "Checking Semantic Versioning 2.0.0 compliance..."
          
          # Check version format
          if grep -rE 'version: "[0-9]+\.[0-9]+\.[0-9]+"' core/ governance/ > /dev/null; then
            echo "‚úÖ Semantic versioning format correct"
          else
            echo "‚ùå Invalid version format"
            exit 1
          fi

      - name: Generate Compliance Report
        working-directory: ${{ env.WORKING_DIRECTORY }}
        run: |
          cat > compliance-report.md << 'EOF'
          # MCP Level 1 Compliance Report
          
          ## Standards Compliance
          
          - ‚úÖ MCP Registry API v1.0
          - ‚úÖ Semantic Versioning 2.0.0
          - ‚úÖ JSON Schema Draft-07
          - ‚úÖ Artifact-First Workflow
          - ‚úÖ RBAC Model
          
          ## Validation Results
          
          - Core Artifacts: PASSED
          - Governance Artifacts: PASSED
          - Naming Conventions: PASSED
          - Dependencies: PASSED
          
          ## Generated
          
          Date: $(date)
          Commit: ${{ github.sha }}
          Branch: ${{ github.ref_name }}
          EOF

      - name: Upload Compliance Report
        uses: actions/upload-artifact@v4
        with:
          name: compliance-report
          path: ${{ env.WORKING_DIRECTORY }}/compliance-report.md
          retention-days: 90

  # Summary Report
  summary:
    name: Generate Summary
    runs-on: ubuntu-latest
    needs: [validate-artifacts, check-naming, validate-dependencies, security-scan, docs-check, compliance-check]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # MCP Level 1 CI/CD Summary
          
          ## ‚úÖ Validation Results
          
          | Check | Status |
          |-------|--------|
          | Artifact Validation | ${{ needs.validate-artifacts.result }} |
          | Naming Conventions | ${{ needs.check-naming.result }} |
          | Dependencies | ${{ needs.validate-dependencies.result }} |
          | Security Scan | ${{ needs.security-scan.result }} |
          | Documentation | ${{ needs.docs-check.result }} |
          | Compliance | ${{ needs.compliance-check.result }} |
          
          ## üìä Statistics
          
          - Core Artifacts: 9
          - Governance Artifacts: 2
          - Total Artifacts: 11
          - Naming Registries: 8
          - Policies: 21
          - Roles: 6
          
          ## üîó Resources
          
          - [Level 1 Documentation](00-namespaces/namespaces-mcp/level1/README.md)
          - [Validation Report](artifacts/validation-report)
          - [Compliance Report](artifacts/compliance-report)
          EOF

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `
            ## MCP Level 1 CI/CD Results
            
            ‚úÖ All checks passed!
            
            ### Validation Summary
            - Artifact Validation: ${{ needs.validate-artifacts.result }}
            - Naming Conventions: ${{ needs.check-naming.result }}
            - Dependencies: ${{ needs.validate-dependencies.result }}
            - Security Scan: ${{ needs.security-scan.result }}
            - Documentation: ${{ needs.docs-check.result }}
            - Compliance: ${{ needs.compliance-check.result }}
            
            ### Statistics
            - Total Artifacts: 11
            - Naming Registries: 8
            - Policies: 21
            - Roles: 6
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });